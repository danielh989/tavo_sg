function crear_orden(){var a={id_mesa:"",productos:[]},b={},c=($(".modal-header"),$(".modal-body")),d=$(".modal-footer");$("#myModal").on("hidden.bs.modal",function(){a={id_mesa:"",productos:[]}}),$(".table-add").on("click",function(){var a=($(this),"/tavo_sg/mesas/libres"),b="get",e={};$.ajax({url:a,type:b,data:e,success:function(a){c.html(""),d.html(""),$.get("/tavo_sg/assets/templates/mesas_disponibles.mst",function(b){$.each(a,function(d,e){c.append(Mustache.render(b,a[d]))})})}})}),$(c).on("click",".mesa-libre",function(){var e=$(this),f="categorias/getJSON",g="post",h={};a.id_mesa=e.data("id"),$.ajax({url:f,type:g,data:h,success:function(a){b=a,c.html(""),d.html(""),$.get("assets/templates/btn-completar.mst",function(a){d.append(Mustache.render(a))}),$.get("assets/templates/categorias.mst",function(b){$.each(a,function(d,e){c.append(Mustache.render(b,a[d]))})})}})}),$(".modal-body").on("click",".categoria",function(){var a=($(this),"productos/getJSON"),b="post",e={};e.id_cat=$(this).data("id"),$.ajax({url:a,type:b,data:e,success:function(a){c.html(""),d.html(""),$.get("assets/templates/btn-completar.mst",function(a){d.append(Mustache.render(a))}),a.length>0?($.get("assets/templates/back-btn.mst",function(a){c.append(Mustache.render(a))}),$.get("assets/templates/productos.mst",function(b){$.each(a,function(d,e){c.append(Mustache.render(b,a[d]))})})):$.get("assets/templates/back-btn.mst",function(a){c.append(Mustache.render(a)),c.append('<h3 class="text-center text-muted">No hay productos</h3>')})}})}),c.on("click",".btn-agregar",function(){var b=$(this),c=0,d=b.closest(".number-wrapper").find(".cantidad"),e=parseInt(d.text());d.html(""),""==a.productos?(a.productos.push({id:b.data("id"),cantidad:"1",nombre:b.data("nombre")}),d.append("1")):($.each(a.productos,function(f,g){a.productos[f].id===b.data("id")&&(a.productos[f].cantidad=parseInt(a.productos[f].cantidad)+1,a.productos[f].id=b.data("id"),a.productos[f].nombre=b.data("nombre"),d.append(e+1),c=1)}),0==c&&(a.productos.push({id:b.data("id"),cantidad:"1",nombre:b.data("nombre")}),d.append("1")))}),c.on("click",".btn-atras",function(){var e=$.merge(b,a);c.html(""),console.log(a.productos),$.get("assets/templates/categorias.mst",function(a){$.each(b,function(b,d){c.append(Mustache.render(a,e[b]))})}),d.html(""),d.append('<h3 class="text-center" style="text-transform: uppercase">Resumen de Orden</h3>'),$.get("assets/templates/resumen-pedido.mst",function(b){d.append(Mustache.render(b)),$.each(a.productos,function(b,c){var d=$(".table tbody");d.append("<tr> <td>"+a.productos[b].nombre+"</td> <td>"+a.productos[b].cantidad+"</td></tr>")}),$.get("assets/templates/btn-completar.mst",function(a){d.append(Mustache.render(a))})})}),d.on("click",".btn-completar",function(){var b="post",c="pedidos/add",d=a;$.ajax({url:c,type:b,data:d,success:function(a){window.location="http://localhost/tavo_sg/"}})})}function formatoPago(){function a(a,b){a.maskMoney("mask"),b.maskMoney("mask")}var b=null;$(document).on("change","#descuento",function(){b=$("#total_form").data("total"),efectivo=$("#efectivo"),debito=$("#debito"),porc_des=$("#porc_des").data("descuento"),this.checked?(b=parseFloat(b)-parseFloat(b)*(parseFloat(porc_des)/100),b=RoundToDecimal(b,2),total_text=b.toString().split("."),$("#total_0").text(total_text[0]),$("#total_1").text("."+total_text[1]),debito.val("0.00"),efectivo.val("0.00"),a(debito,efectivo),$('input[type="radio"]').prop("checked",!1)):(b=$("#total_form").data("total"),b=RoundToDecimal(b,2),total_text=b.toString().split("."),$("#total_0").text(total_text[0]),$("#total_1").text("."+total_text[1]),debito.val("0.00"),efectivo.val("0.00"),a(debito,efectivo),$('input[type="radio"]').prop("checked",!1))}),$(document).on("keyup","#efectivo",function(){var c=$("#efectivo"),d=$("#debito");b=b=null==b?$("#total_form").data("total"):b,c.maskMoney({thousands:".",decimal:",",allowZero:!1,suffix:" Bs.F"}),c.maskMoney("mask"),valor=$(this).maskMoney("unmasked")[0],valor=RoundToDecimal(valor,2),parseFloat(valor)>parseFloat(b)&&($(this).val(b),valor=b);var e=b-valor;d.val(RoundToDecimal(e,2)),a(d,c),$('#pay-form input[type="radio"]').prop("checked",!1)}),$(document).on("keyup","#debito",function(){var b=$("#efectivo"),c=$("#debito"),d=$("#total_form").data("total");c.maskMoney({thousands:".",decimal:",",allowZero:!1,suffix:" Bs.F"}),c.maskMoney("mask"),valor=$(this).maskMoney("unmasked")[0],valor=RoundToDecimal(valor,2),parseFloat(valor)>parseFloat(d)&&($(this).val(d),valor=d);var e=parseFloat(d)-parseFloat(valor);b.val(RoundToDecimal(e,2)),a(c,b),$('#pay-form input[type="radio"]').prop("checked",!1)}),$(document).on("submit","#pay-form",function(c){var d=$(this),e=$("#efectivo"),f=$("#debito");return b=b=null==b?$("#total_form").data("total"):b,pago=parseFloat(e.maskMoney("unmasked")[0])+parseFloat(f.maskMoney("unmasked")[0]),pago=RoundToDecimal(pago,2),parseFloat(pago)<parseFloat(b)?(a(f,e),alert("No se ha completado el pago de la orden")):d.submit(),!1}),$(document).on("click","input[type=radio]",function(){var c=$(this).attr("value"),d=$(".modal-footer button[type=submit]"),e=$("#efectivo"),f=$("#debito");switch(b=b=null==b?$("#total_form").data("total"):b,c){case"efectivo":e.val(RoundToDecimal(b,2)),f.val("0.00"),e.trigger("focus"),f.trigger("focus"),d.trigger("focus"),a(f,e);break;case"debito":f.val(RoundToDecimal(b,2)),e.val("0.00"),f.trigger("focus"),e.trigger("focus"),d.trigger("focus"),a(f,e)}})}function RoundToDecimal(a,b){var c=new String(1..toFixed(b));c=c.substr(2);var d=parseFloat("1"+c),e=parseFloat("."+c+"01");return 10*a*d%10>=5&&(a+=e),(Math.round(a*d)/d).toFixed(b)}function gestionarCategorias(){$(".agregar-categoria").on("click",function(){var a=$(this),b=a.data("id");nombre=a.find("h4").data("nombre"),$("input[name=id]").val(b),$("input[name=nombre]").val(nombre),$("span.error").empty()}),$(".eliminar_categoria").on("click",function(){var a=$(this).closest(".agregar-categoria"),b=a.data("id"),c={};c.id_categoria=b,console.log(b),$.ajax({type:"POST",url:"categorias/delete",data:c,success:function(b){1451==$.parseJSON(b).code?alert("No se puede eliminar la categoria porque pertenece a un pedido"):(a.remove(),location.reload())}})}),$("#form-categoria").submit(function(a){a.preventDefault();var b=$("#form-categoria"),c=b.attr("method"),d=b.attr("action"),e=b.serialize();$.ajax({type:c,url:d,data:e,success:function(a){1062==$.parseJSON(a).code?$("span.error").empty().append("Ya existe una categoria con ese nombre"):location.reload()}})})}function gestionarMesas(){$(".agregar-mesa").on("click",function(){var a=$(this).find("div"),b=a.find("p").data("id");numero=a.find("h2").data("numero"),nombre=a.find("h4").data("nombre"),$("input[name=id]").val(b),$("input[name=nombre]").val(nombre),$("input[name=numero]").val(numero),$("span.error").empty()}),$(".eliminar_mesa").on("click",function(){var a=$(this).closest("div"),b=a.find("p").data("id");$.ajax({type:"POST",url:"mesas/delete",data:{id_mesa:b},success:function(b){1451==$.parseJSON(b).code?alert("No se puede eliminar la mesa porque pertenece a un pedido"):a.closest("a").remove()}})}),$("#form-mesa").submit(function(a){a.preventDefault();var b=$("#form-mesa"),c=b.attr("method"),d=b.attr("action"),e=b.serialize();$.ajax({type:c,url:d,data:e,success:function(a){1062==$.parseJSON(a).code?$("span.error").empty().append("El nombre o numero de mesa ya existe"):location.reload()}})})}function gestionarPedidos(){$(".btn-eliminar").on("click",function(){var a="post",b="/tavo_sg/Productosxpedido/delete",c={};c.id_pedido=$(this).data("pedido"),c.id_producto=$(this).data("producto"),$.ajax({type:a,url:b,data:c,success:function(a){location.reload()}})}),$(".btn-eliminar-devuelto").on("click",function(){var a="post",b="/tavo_sg/Productosxpedido/deleteDevuelto",c={};c.id_pedido=$(this).data("pedido"),c.id_producto=$(this).data("producto"),$.ajax({type:a,url:b,data:c,success:function(a){location.reload()}})}),$(".btn-devolver").on("click",function(){var a="post",b="/tavo_sg/Productosxpedido/devolver",c={};c.id_pedido=$(this).data("pedido"),c.id_producto=$(this).data("producto"),$.ajax({type:a,url:b,data:c,success:function(a){location.reload()}})})}function gestionarProductos(){$(".btn-agregar").on("click",function(){getCategorias("#id_cat",0),$("input").val(""),$("textarea").val("")}),$(".btn-guardar").on("click",function(){var a=$("form#producto"),b=a.attr("method"),c=a.attr("action"),d=a.serialize();$.ajax({type:b,url:c,data:d,success:function(a){a.st?location.reload():$("span.error").append("Opps! Ocurrio un error, intentalo nuevamente.")}})}),$(".table tbody .btn-editar").on("click",function(){var a=$(this).closest("tr"),b=a.data("id-producto"),c=a.find(".categoria").attr("data-idcat");$("input[name=id]").val(b),$("input[name=nombre]").val(a.find(".nombre").text()),$("input[name=precio]").val(a.find(".precio").text()),$("textarea[name=descripcion]").val(a.find(".descripcion").text()),getCategorias("#id_cat",1,c)}),$(".table tbody .btn-eliminar").on("click",function(){var a=$(this).closest("tr"),b=a.data("id-producto");$("#eliminarProducto a").attr("href","productos/delete/"+b)})}function getCategorias(a,b,c){var d="post",e="/tavo_sg/categorias/getJSON",f={};$.ajax({type:d,url:e,data:f,success:function(d){sel=$(a),sel.empty(),sel.append('<option value="0">Seleccionar...</option>'),$.each(d,function(a,b){sel.append('<option value="'+d[a].id+'">'+d[a].nombre+"</option>")}),1==b&&sel.val(c)}})}function opciones_pedido(){var a={pedido:{id_pedido:"",id_mesa:"",productos:[]},init:function(){this.cacheDOM(),this.bindEvents(),this.cambiarMesa(),this.pedido.id_pedido=$("#id_pedido").data("id-pedido")},cacheDOM:function(){this.$header=$(".modal-header"),this.$body=$(".modal-body"),this.$footer=$(".modal-footer"),this.$modalTitle=$(".modal-title"),this.$opciones=$(".pedido-opciones"),this.$btnMesa=$(".pedido-opciones .table-add"),this.$btnOrdenar=$(".pedido-opciones .ordenar"),this.$btnPagar=$(".pedido-opciones .pagar"),this.$mesaDisponible=$(".mesa-para-cambio"),this.$idPedido=$("#id_pedido"),this.$categoria=$(document),this.$btnBack=$(document),this.$btnCompletar=$(document),this.$btnAgregar=$(document)},bindEvents:function(){this.$btnMesa.on("click",this.mesasDisponibles.bind(this)),this.$btnPagar.on("click",this.pagar.bind(this)),this.$btnOrdenar.on("click",this.ordenar.bind(this)),this.$categoria.on("click",".categoria",this.mostrarProductos),this.$btnBack.on("click",".go-back",this.ordenar.bind(this)),this.$btnAgregar.on("click",".btn-agregar",this.agregarProducto.bind(this)),this.$btnCompletar.on("click",".btn-completar",this.completarOrden.bind(this))},mesasDisponibles:function(){var a=this;url="/tavo_sg/mesas/libres",type="get",$.ajax({url:url,type:type,success:function(b){a.$modalTitle.text("Cambiar Mesa"),a.$body.html(""),a.$footer.html(""),$.get("/tavo_sg/assets/templates/mesas_disponibles_cambio.mst",function(c){$.each(b,function(d,e){a.$body.append(Mustache.render(c,b[d]))})})}})},cambiarMesa:function(){var a=this.$idPedido.data("id-pedido");$(document).on("click",".mesa-para-cambio",function(){var b=$(this).data("id"),c="/tavo_sg/pedidos/cambiar_mesa",d="post",e={};e.id_pedido=a,e.id_mesa=b,$.ajax({url:c,type:d,data:e,success:function(a){location.reload()}})})},pagar:function(){var a=this,b=$("#payment-body").html(),c=$("#pagar-buttons").html();a.$body.html(""),a.$modalTitle.text("Pagar"),a.$body.append(Mustache.render(b)),a.$footer.html(""),a.$footer.append(Mustache.render(c))},ordenar:function(){var a=this,b="/tavo_sg/categorias/getJSON",c="post",d={};this.$modalTitle.text("Ordenar"),this.pedido.id_mesa=this.$btnOrdenar.data("id"),$.ajax({url:b,type:c,data:d,success:function(b){categorias=b,a.$body.html(""),a.$footer.html(""),$.get("/tavo_sg/assets/templates/btn-completar.mst",function(b){a.$footer.append(Mustache.render(b))}),$.get("/tavo_sg/assets/templates/categorias.mst",function(c){$.each(b,function(d,e){a.$body.append(Mustache.render(c,b[d]))})})}})},mostrarProductos:function(){var a=($(this),"/tavo_sg/productos/getJSON"),b="post",c={},d=($(".modal-title"),$(".modal-body")),e=$(".modal-footer");c.id_cat=$(this).data("id"),$.ajax({url:a,type:b,data:c,success:function(a){d.html(""),e.html(""),$.get("/tavo_sg/assets/templates/btn-completar.mst",function(a){e.append(Mustache.render(a))}),a.length>0?($.get("/tavo_sg/assets/templates/back-btn.mst",function(a){d.append(Mustache.render(a))}),$.get("/tavo_sg/assets/templates/productos.mst",function(b){$.each(a,function(c,e){d.append(Mustache.render(b,a[c]))})})):$.get("/tavo_sg/assets/templates/back-btn.mst",function(a){d.append(Mustache.render(a)),d.append('<h3 class="text-center text-muted">No hay productos</h3>')})}})},agregarProducto:function(a){var b=this,c=0,d=$(a.target).closest(".number-wrapper").find(".cantidad"),e=parseInt(d.text()),f=$(a.target).closest(".btn-agregar");d.html(""),""==b.pedido.productos?(b.pedido.productos.push({id:f.data("id"),cantidad:"1",nombre:f.data("nombre")}),d.append("1")):($.each(b.pedido.productos,function(a,g){b.pedido.productos[a].id===f.data("id")&&(b.pedido.productos[a].cantidad=parseInt(b.pedido.productos[a].cantidad)+1,b.pedido.productos[a].id=f.data("id"),b.pedido.productos[a].nombre=f.data("nombre"),d.append(e+1),c=1)}),0==c&&(b.pedido.productos.push({id:f.data("id"),cantidad:"1",nombre:f.data("nombre")}),d.append("1")))},completarOrden:function(a){var b="post",c="/tavo_sg/pedidos/add_product_to_order",d=this.pedido;redirect="http://localhost/tavo_sg/pedidos/detalle/"+this.pedido.id_pedido,$.ajax({url:c,type:b,data:d,success:function(a){window.location=redirect}})}};a.init()}